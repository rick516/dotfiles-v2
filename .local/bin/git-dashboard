#!/bin/bash
# git-dashboard: 複数リポジトリの状態一覧 + lazygitで詳細表示

# PATHにHomebrewを追加（zellij経由で起動時に必要）
export PATH="/opt/homebrew/bin:$PATH"

BASE_DIR="${1:-$HOME/Documents/Dev}"

# 色定義
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
DIM='\033[2m'
NC='\033[0m'

get_repo_status() {
    local repo_path="$1"
    local repo_name=$(basename "$repo_path")

    cd "$repo_path" 2>/dev/null || return

    # ブランチ名
    local branch=$(git symbolic-ref --short HEAD 2>/dev/null || git rev-parse --short HEAD 2>/dev/null || echo "?")

    # ステータス取得
    local status=$(git status --porcelain 2>/dev/null)
    local modified=$(echo "$status" | grep -c "^ M\|^M\|^MM" 2>/dev/null | tr -d '\n' || echo 0)
    local staged=$(echo "$status" | grep -c "^A\|^M \|^R\|^D " 2>/dev/null | tr -d '\n' || echo 0)
    local untracked=$(echo "$status" | grep -c "^??" 2>/dev/null | tr -d '\n' || echo 0)

    # ahead/behind
    local ahead_behind=$(git rev-list --left-right --count @{upstream}...HEAD 2>/dev/null || echo "0	0")
    local behind=$(echo "$ahead_behind" | cut -f1)
    local ahead=$(echo "$ahead_behind" | cut -f2)

    # ステータス表示（わかりやすく）
    local status_text=""
    local total_changes=$((modified + staged + untracked))

    if [ "$total_changes" -eq 0 ]; then
        status_text="${GREEN}clean${NC}"
    else
        local parts=()
        [ "$modified" -gt 0 ] && parts+=("${YELLOW}${modified}編集${NC}")
        [ "$staged" -gt 0 ] && parts+=("${GREEN}${staged}staged${NC}")
        [ "$untracked" -gt 0 ] && parts+=("${CYAN}${untracked}new${NC}")
        status_text=$(IFS=' '; echo "${parts[*]}")
    fi

    # 同期状態
    local sync_text=""
    if [ "$ahead" -gt 0 ] && [ "$behind" -gt 0 ]; then
        sync_text="${YELLOW}↑${ahead} ↓${behind}${NC}"
    elif [ "$ahead" -gt 0 ]; then
        sync_text="${GREEN}↑${ahead} push可${NC}"
    elif [ "$behind" -gt 0 ]; then
        sync_text="${RED}↓${behind} pull必要${NC}"
    fi

    # 出力（タブ区切りでfzf用）
    # 形式: path \t repo \t branch \t status \t sync
    printf "%s\t%s\t%s\t%b\t%b\n" "$repo_path" "$repo_name" "$branch" "$status_text" "$sync_text"
}

main() {
    while true; do
        selected=$(
            {
                while IFS= read -r git_dir; do
                    repo_path=$(dirname "$git_dir")
                    get_repo_status "$repo_path"
                done < <(find "$BASE_DIR" -maxdepth 3 -name ".git" -type d 2>/dev/null | sort)
            } | fzf --ansi \
                    --header="Enter: lazygit で開く" \
                    --delimiter="\t" \
                    --with-nth=2,3,4,5 \
                    --tabstop=4
        )

        [ -z "$selected" ] && break

        repo_path=$(echo "$selected" | cut -f1)
        [ -d "$repo_path" ] && lazygit -p "$repo_path"
    done
}

main
